{% extends "base.html" %}
{% block title %}{{ course.title }} ‚Äî –æ–±—É—á–µ–Ω–∏–µ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/course_learning.css') }}">
{% endblock %}

{% block content %}
<div class="container course-detail">
    <h1>{{ course.title }}</h1>
    <p>{{ course.description }}</p>

    {% if lesson %}
    <h2>{{ lesson.title }}</h2>
    <div class="lesson-content">
        {{ lesson.content | safe }}
        <div class="ai-help-wrapper">
            <button class="ai-help-btn" onclick="openChat()">ü§ñ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ —É—Ä–æ–∫—É</button>
        </div>
    </div>

    <!-- –¢–µ–∫—Å—Ç —É—Ä–æ–∫–∞ –±–µ–∑ —Ç–µ–≥–æ–≤ -->
    <div id="lesson-context" style="display:none;">
        {{ lesson.content | striptags | truncate(3000) }}
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ò–ò -->
    <div id="chat-modal" class="chat-modal">
        <div class="chat-box">
            <div class="chat-header">
                <span>–ß–∞—Ç —Å –ò–ò</span>
                <button onclick="closeChat()">√ó</button>
            </div>
            <div id="chat-messages" class="chat-messages empty"></div>
            <div class="chat-input">
                <input type="text" id="user-question" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..." />
                <button onclick="sendQuestion()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="lesson-tasks">
        <h3>–í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–∏–∑—É—á–µ–Ω–∏—è:</h3>
        {% if lesson.tasks %}
        <ul class="tasks">
            {% for task in lesson.tasks %}
            <li>{{ task.position }}. {{ task.text }}</li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>
        {% endif %}
    </div>

    <div class="course-quiz">
        <h2>–ö–≤–∏–∑—ã —ç—Ç–æ–≥–æ —É—Ä–æ–∫–∞:</h2>
        {% if quizzes %}
        {% if quizzes|length == 1 %}
        <a class="btn start-quiz-btn" href="{{ url_for('courses.course_quiz', slug=course.slug, id=quizzes[0].id) }}">
            –ü—Ä–æ–π—Ç–∏ –∫–≤–∏–∑ –ø–æ —É—Ä–æ–∫—É
        </a>
        {% else %}
        <h3>–ö–≤–∏–∑—ã –ø–æ —É—Ä–æ–∫—É:</h3>
        <ul>
            {% for quiz in quizzes %}
            <li>
                <a href="{{ url_for('courses.course_quiz', slug=course.slug, id=quiz.id) }}">
                    {{ quiz.title }}
                </a>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
        {% else %}
        <p>–ö–≤–∏–∑—ã –∫ —ç—Ç–æ–º—É —É—Ä–æ–∫—É –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>
        {% endif %}
    </div>
    {% else %}
    <h2>–ú–æ–¥—É–ª–∏ –∫—É—Ä—Å–∞:</h2>
    <div class="modules">
        {% for module in modules %}
        <div class="module">
            <button class="module-title" onclick="toggleVisibility('module-{{ module.id }}')">
                {{ module.position }}. {{ module.title }}
            </button>

            <div class="module-content" id="module-{{ module.id }}">
                {% if module.lessons %}
                <ul class="lessons">
                    {% for lesson in module.lessons %}
                    <li class="lesson">
                        <a href="{{ url_for('courses.course_learning', slug=course.slug, lesson_id=lesson.id) }}">
                            <strong>{{ lesson.position }}. {{ lesson.title }}</strong>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="no-lessons">–£—Ä–æ–∫–∏ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleVisibility(id) {
        var element = document.getElementById(id);
        if (element.style.display === "none" || element.style.display === "") {
            element.style.display = "block";
        } else {
            element.style.display = "none";
        }
    }
</script>
<script src="{{ url_for('static', filename='js/aiChatResponse.js') }}"></script>
{% endblock %}